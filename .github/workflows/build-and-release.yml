name: Build and Release VS Code Extension

on:
  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒç‰ˆæœ¬å·æ›´æ–°
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.3, 0.1.0, 1.0.0-beta.1) - å¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å‰ç‰ˆæœ¬å·'
        required: false
        type: string
      release_type:
        description: 'å‘å¸ƒç±»åž‹'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - 'release'
          - 'prerelease'
          - 'draft'
      update_version:
        description: 'æ˜¯å¦æ›´æ–°ç‰ˆæœ¬å· (å¦‚æžœæŒ‡å®šäº†æ–°ç‰ˆæœ¬å·)'
        required: true
        default: false
        type: boolean
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºGitHub Release'
        required: true
        default: true
        type: boolean
      custom_release_notes:
        description: 'è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜Ž (å¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨ä»ŽCHANGELOG.mdè¯»å–)'
        required: false
        type: string
      auto_changelog:
        description: 'è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿—'
        required: true
        default: true
        type: boolean
      publish_marketplace:
        description: 'å‘å¸ƒåˆ°VS Code Marketplace (ä»…åœ¨releaseç±»åž‹æ—¶ç”Ÿæ•ˆ)'
        required: true
        default: false
        type: boolean

  # è‡ªåŠ¨è§¦å‘ - æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»ºï¼ˆä¸æ›´æ–°ç‰ˆæœ¬å·ï¼‰
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

  # Pull Requestè§¦å‘
  pull_request:
    branches:
      - main
      - master

# æ·»åŠ æƒé™é…ç½®ï¼Œç¡®ä¿å¯ä»¥åˆ›å»º Release å’Œå†™å…¥å†…å®¹
permissions:
  contents: write
  pull-requests: read
  issues: read
  packages: write

env:
  NODE_VERSION: '20'

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      vsix-name: ${{ steps.build.outputs.vsix-name }}
      should_release: ${{ steps.version.outputs.should_release }}
      version_updated: ${{ steps.version.outputs.version_updated }}
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: å¤„ç†ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "å½“å‰package.jsonç‰ˆæœ¬å·: $CURRENT_VERSION"
            
            if [ -n "${{ github.event.inputs.version }}" ] && [ "${{ github.event.inputs.update_version }}" = "true" ]; then
              # ç”¨æˆ·æä¾›äº†æ–°ç‰ˆæœ¬å·ä¸”é€‰æ‹©æ›´æ–°
              NEW_VERSION="${{ github.event.inputs.version }}"
              echo "æ›´æ–°ç‰ˆæœ¬å·åˆ°: $NEW_VERSION"
              npm version $NEW_VERSION --no-git-tag-version
              
              # é…ç½®gitç”¨æˆ·ä¿¡æ¯
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              
              # æäº¤ç‰ˆæœ¬æ›´æ”¹
              git add package.json
              git commit -m "chore: bump version to $NEW_VERSION" || echo "No changes to commit"
              git push origin ${{ github.ref_name }} || echo "No changes to push"
              
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "version_updated=true" >> $GITHUB_OUTPUT
            elif [ -n "${{ github.event.inputs.version }}" ]; then
              # ç”¨æˆ·æä¾›äº†ç‰ˆæœ¬å·ä½†ä¸æ›´æ–°package.json (ä»…ç”¨äºŽå‘å¸ƒ)
              RELEASE_VERSION="${{ github.event.inputs.version }}"
              echo "ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬å·è¿›è¡Œå‘å¸ƒ (ä¸æ›´æ–°package.json): $RELEASE_VERSION"
              echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
              echo "version_updated=false" >> $GITHUB_OUTPUT
            else
              # ä½¿ç”¨å½“å‰ç‰ˆæœ¬å·
              echo "ä½¿ç”¨å½“å‰ç‰ˆæœ¬å·è¿›è¡Œå‘å¸ƒ: $CURRENT_VERSION"
              echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
              echo "version_updated=false" >> $GITHUB_OUTPUT
            fi
            
            echo "is_manual=true" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            # è‡ªåŠ¨è§¦å‘ - æ£€æŸ¥ç‰ˆæœ¬å·å˜åŒ–
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            
            # èŽ·å–ä¸Šä¸€æ¬¡çš„ç‰ˆæœ¬å·
            PREVIOUS_VERSION=""
            if [ "${{ github.event_name }}" = "push" ]; then
              # å°è¯•ä»Žä¸Šä¸€ä¸ªæäº¤èŽ·å–ç‰ˆæœ¬å·
              git fetch origin ${{ github.ref_name }}
              if git show HEAD~1:package.json > /dev/null 2>&1; then
                PREVIOUS_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version" 2>/dev/null || echo "")
              fi
            fi
            
            echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
            echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREVIOUS_VERSION"
            
            # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å˜åŒ–
            if [ -n "$PREVIOUS_VERSION" ] && [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬å·å˜åŒ–: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
              echo "å°†æ‰§è¡Œå®Œæ•´çš„å‘å¸ƒæµç¨‹..."
              echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "version_updated=false" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸  ç‰ˆæœ¬å·æœªå˜åŒ–ï¼Œæ‰§è¡Œæ™®é€šæž„å»º..."
              BUILD_NUMBER=${{ github.run_number }}
              VERSION_WITH_BUILD="${CURRENT_VERSION}+build.${BUILD_NUMBER}"
              echo "æž„å»ºç‰ˆæœ¬: $VERSION_WITH_BUILD"
              echo "version=$VERSION_WITH_BUILD" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "version_changed=false" >> $GITHUB_OUTPUT
              echo "version_updated=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: è¿è¡Œæµ‹è¯•
        run: |
          if [ -f "package.json" ] && npm run | grep -q "test"; then
            echo "éªŒè¯æž„å»ºäº§ç‰©..."
            # åŸºæœ¬æž„å»ºéªŒè¯ - ä¸éœ€è¦å¯åŠ¨ VS Code
            node -e "
              const assert = require('assert');
              const fs = require('fs');
              
              console.log('ðŸ” éªŒè¯ package.json...');
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              assert.ok(pkg.name, 'Package name should exist');
              assert.ok(pkg.version, 'Package version should exist');
              assert.ok(pkg.engines.vscode, 'VS Code engine should be specified');
              
              console.log('ðŸ” éªŒè¯ç¼–è¯‘äº§ç‰©...');
              assert.ok(fs.existsSync('dist/extension.js'), 'Compiled extension should exist');
              
              console.log('ðŸ” éªŒè¯è¯­è¨€é…ç½®æ–‡ä»¶...');
              const languageFiles = [
                'syntaxes/mdp/mdp.tmLanguage.json',
                'syntaxes/gro/gro.tmLanguage.json', 
                'syntaxes/top/top.tmLanguage.json',
                'syntaxes/ndx/ndx.tmLanguage.json'
              ];
              languageFiles.forEach(file => {
                assert.ok(fs.existsSync(file), \`Language file \${file} should exist\`);
              });
              
              console.log('ðŸ” éªŒè¯ä»£ç ç‰‡æ®µæ–‡ä»¶...');
              const snippetFiles = ['snippets/mdp.json', 'snippets/gro.json', 'snippets/ndx.json'];
              snippetFiles.forEach(file => {
                assert.ok(fs.existsSync(file), \`Snippet file \${file} should exist\`);
                JSON.parse(fs.readFileSync(file, 'utf8')); // éªŒè¯ JSON æ ¼å¼
              });
              
              console.log('âœ… æ‰€æœ‰æž„å»ºéªŒè¯é€šè¿‡ï¼');
            "
            
            echo "æ³¨æ„: VS Code æ‰©å±•åŠŸèƒ½æµ‹è¯•åœ¨ CI çŽ¯å¢ƒä¸­è¢«è·³è¿‡"
            echo "å®Œæ•´çš„æ‰©å±•æµ‹è¯•è¯·åœ¨æœ¬åœ°å¼€å‘çŽ¯å¢ƒä¸­è¿è¡Œ: npm test"
          else
            echo "è·³è¿‡æµ‹è¯• - æœªé…ç½®æµ‹è¯•å‘½ä»¤"
          fi

      - name: æ‰“åŒ…æ‰©å±•
        id: build
        run: |
          # å®‰è£…vsceå¦‚æžœæ²¡æœ‰
          if ! command -v vsce &> /dev/null; then
            npm install -g @vscode/vsce
          fi
          
          # èŽ·å–è¦ä½¿ç”¨çš„ç‰ˆæœ¬å·
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TARGET_VERSION="${{ steps.version.outputs.version }}"
          
          echo "Package.jsonç‰ˆæœ¬: $PACKAGE_VERSION"
          echo "ç›®æ ‡å‘å¸ƒç‰ˆæœ¬: $TARGET_VERSION"
          
          # æ‰“åŒ…æ‰©å±•
          if [ "${{ steps.version.outputs.should_release }}" = "true" ]; then
            if [ "$PACKAGE_VERSION" = "$TARGET_VERSION" ]; then
              # ç‰ˆæœ¬å·ä¸€è‡´ï¼Œç›´æŽ¥ä½¿ç”¨package.jsonç‰ˆæœ¬
              vsce package
              VSIX_FILE=$(ls *.vsix | head -n 1)
            else
              # ç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼Œä½¿ç”¨æŒ‡å®šç‰ˆæœ¬å·æ‰“åŒ…
              vsce package --out "gromacs-helper-vscode-${TARGET_VERSION}.vsix"
              VSIX_FILE="gromacs-helper-vscode-${TARGET_VERSION}.vsix"
            fi
          else
            # æ™®é€šæž„å»º - ä½¿ç”¨å¸¦æž„å»ºå·çš„ç‰ˆæœ¬
            vsce package --out "gromacs-helper-vscode-${{ steps.version.outputs.version }}.vsix"
            VSIX_FILE="gromacs-helper-vscode-${{ steps.version.outputs.version }}.vsix"
          fi
          
          echo "ç”Ÿæˆçš„VSIXæ–‡ä»¶: $VSIX_FILE"
          echo "vsix-name=$VSIX_FILE" >> $GITHUB_OUTPUT
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$VSIX_FILE" ]; then
            echo "é”™è¯¯: VSIXæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -la *.vsix

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package-${{ steps.version.outputs.version }}
          path: "*.vsix"
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: vsix-package-${{ needs.build.outputs.version }}

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          VSIX_FILE="${{ needs.build.outputs.vsix-name }}"
          
          # ç”ŸæˆåŸºç¡€å‘å¸ƒè¯´æ˜Žæ¨¡æ¿
          cat > release_notes_template.md << 'EOF'
          # GROMACS Helper for VS Code v${VERSION}
          
          ## ðŸ“¦ å®‰è£…æ–¹å¼

          ### æ–¹å¼ä¸€ï¼šé€šè¿‡VS Codeæ‰©å±•å¸‚åœºå®‰è£…
          1. æ‰“å¼€ VS Code
          2. æŒ‰ `Ctrl+Shift+X` (macOS: `Cmd+Shift+X`)
          3. æœç´¢ "GROMACS Helper for VS Code"ï¼ˆ[å¸‚åœºé“¾æŽ¥](https://marketplace.visualstudio.com/items?itemName=mcardzh.gromacs-helper-vscode)ï¼‰
          4. ç‚¹å‡»å®‰è£…æŒ‰é’®
          
          ### æ–¹æ³•äºŒï¼šä»ŽVSIXæ–‡ä»¶å®‰è£…
          1. ä¸‹è½½é™„ä»¶ä¸­çš„ `${VSIX_FILE}` æ–‡ä»¶
          2. åœ¨VS Codeä¸­æŒ‰ `Ctrl+Shift+P` (macOS: `Cmd+Shift+P`)
          3. è¾“å…¥ "Extensions: Install from VSIX..."
          4. é€‰æ‹©ä¸‹è½½çš„VSIXæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ### æ–¹æ³•ä¸‰ï¼šå‘½ä»¤è¡Œå®‰è£…
          ```bash
          code --install-extension ${VSIX_FILE}
          ```
          
          ## ðŸš€ åŠŸèƒ½ç‰¹æ€§
          
          - ðŸ“ **è¯­æ³•é«˜äº®**: å®Œæ•´æ”¯æŒMDPã€TOPã€GROã€NDXã€PDBã€XVGæ–‡ä»¶æ ¼å¼
          - ðŸ” **æ™ºèƒ½æç¤º**: å‚æ•°è‡ªåŠ¨è¡¥å…¨å’Œæ‚¬åœå¸®åŠ©
          - ðŸ“‹ **ä»£ç ç‰‡æ®µ**: å¸¸ç”¨æ¨¡æ¿å¿«é€Ÿæ’å…¥
          - ðŸŽ¯ **ç¬¦å·å¯¼èˆª**: å¿«é€Ÿè·³è½¬å’Œå¤§çº²è§†å›¾
          - ðŸ“ **ä»£ç æ ¼å¼åŒ–**: è‡ªåŠ¨æ ¼å¼åŒ–æ”¯æŒ
          - ðŸ”§ **è¯Šæ–­åŠŸèƒ½**: å®žæ—¶é”™è¯¯æ£€æŸ¥å’Œå»ºè®®
          
          ## ðŸ”§ æ”¯æŒçš„æ–‡ä»¶ç±»åž‹
          
          - **MDPæ–‡ä»¶** (.mdp) - åˆ†å­åŠ¨åŠ›å­¦å‚æ•°æ–‡ä»¶
          - **TOPæ–‡ä»¶** (.top, .itp) - æ‹“æ‰‘æ–‡ä»¶
          - **GROã€PDBæ–‡ä»¶** (.gro, .pdb) - ç»“æž„åæ ‡æ–‡ä»¶  
          - **XVGæ–‡ä»¶** (.xvg) - æ•°æ®å›¾æ ‡æ–‡ä»¶  
          - **NDXæ–‡ä»¶** (.ndx) - ç´¢å¼•æ–‡ä»¶
          EOF
          
          # æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
          sed -i "s/\${VERSION}/$VERSION/g" release_notes_template.md
          sed -i "s/\${VSIX_FILE}/$VSIX_FILE/g" release_notes_template.md
          
          # å¤„ç†å‘å¸ƒè¯´æ˜Žå†…å®¹
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.custom_release_notes }}" ]; then
            echo "ä½¿ç”¨è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜Ž..."
            echo "${{ github.event.inputs.custom_release_notes }}" > custom_notes.md
            echo "" >> custom_notes.md
            cat release_notes_template.md >> custom_notes.md
            cp custom_notes.md release_notes.md
          elif [ -f "CHANGELOG.md" ] && ([ "${{ github.event_name }}" != "workflow_dispatch" ] || [ "${{ github.event.inputs.auto_changelog }}" = "true" ]); then
            echo "ä»Ž CHANGELOG.md æå–å‘å¸ƒè¯´æ˜Ž..."
            
            # å°è¯•æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
            VERSION_CLEAN=$(echo "$VERSION" | sed 's/^v//')
            echo "æ­£åœ¨æŸ¥æ‰¾ç‰ˆæœ¬: $VERSION_CLEAN"
            
            # æ˜¾ç¤ºCHANGELOG.mdä¸­å­˜åœ¨çš„ç‰ˆæœ¬å·ï¼Œç”¨äºŽè°ƒè¯•
            echo "CHANGELOG.mdä¸­çš„ç‰ˆæœ¬å·:"
            grep -E "^## \[" CHANGELOG.md | head -5 || echo "æœªæ‰¾åˆ°ç‰ˆæœ¬å·æ ¼å¼"
            
            # æŸ¥æ‰¾ç‰ˆæœ¬æ ‡é¢˜çš„å¤šç§æ ¼å¼ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„åŒ¹é…
            CHANGELOG_CONTENT=""
            
            # æ£€æŸ¥ä¸åŒçš„ç‰ˆæœ¬å·æ ¼å¼
            if grep -q "^## \[${VERSION_CLEAN}\]" CHANGELOG.md; then
              echo "æ‰¾åˆ°æ ¼å¼: ## [${VERSION_CLEAN}]"
              # æ ¼å¼: ## [0.0.3] - 2024-01-01
              CHANGELOG_CONTENT=$(awk "
                /^## \[${VERSION_CLEAN}\]/ { found=1; print; next }
                found && /^## \[/ { exit }
                found { print }
              " CHANGELOG.md)
            elif grep -q "^## ${VERSION_CLEAN}" CHANGELOG.md; then
              echo "æ‰¾åˆ°æ ¼å¼: ## ${VERSION_CLEAN}"
              # æ ¼å¼: ## 0.0.3
              CHANGELOG_CONTENT=$(awk "
                /^## ${VERSION_CLEAN}/ { found=1; print; next }
                found && /^## / { exit }
                found { print }
              " CHANGELOG.md)
            elif grep -q "^# v${VERSION_CLEAN}" CHANGELOG.md; then
              echo "æ‰¾åˆ°æ ¼å¼: # v${VERSION_CLEAN}"
              # æ ¼å¼: # v0.0.3
              CHANGELOG_CONTENT=$(awk "
                /^# v${VERSION_CLEAN}/ { found=1; print; next }
                found && /^# v/ { exit }
                found { print }
              " CHANGELOG.md)
            elif grep -q "^### ${VERSION_CLEAN}" CHANGELOG.md; then
              echo "æ‰¾åˆ°æ ¼å¼: ### ${VERSION_CLEAN}"
              # æ ¼å¼: ### 0.0.3
              CHANGELOG_CONTENT=$(awk "
                /^### ${VERSION_CLEAN}/ { found=1; print; next }
                found && /^### / { exit }
                found { print }
              " CHANGELOG.md)
            fi
            
            # æ¸…ç†å†…å®¹ï¼Œç§»é™¤ç©ºè¡Œå¼€å¤´å’Œç»“å°¾
            if [ -n "$CHANGELOG_CONTENT" ]; then
              echo "æˆåŠŸæå–åˆ° $VERSION_CLEAN çš„å˜æ›´æ—¥å¿—å†…å®¹:"
              echo "---å†…å®¹é¢„è§ˆ---"
              echo "$CHANGELOG_CONTENT" | head -10
              echo "---é¢„è§ˆç»“æŸ---"
              
              # ä¿å­˜å˜æ›´æ—¥å¿—å†…å®¹
              echo "## ðŸ“ æœ¬ç‰ˆæœ¬æ›´æ–°" > version_changes.md
              echo "" >> version_changes.md
              # è·³è¿‡æ ‡é¢˜è¡Œï¼Œç›´æŽ¥è¾“å‡ºå†…å®¹
              echo "$CHANGELOG_CONTENT" | tail -n +2 | sed '/^$/d' >> version_changes.md
              echo "" >> version_changes.md
              cat version_changes.md release_notes_template.md > release_notes.md
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION_CLEAN çš„å˜æ›´æ—¥å¿—"
              echo "å°è¯•çš„åŒ¹é…æ¨¡å¼:"
              echo "  - ## [$VERSION_CLEAN]"
              echo "  - ## $VERSION_CLEAN"
              echo "  - # v$VERSION_CLEAN"
              echo "  - ### $VERSION_CLEAN"
              echo "ä½¿ç”¨é»˜è®¤æ¨¡æ¿"
              cp release_notes_template.md release_notes.md
            fi
          else
            echo "ä½¿ç”¨é»˜è®¤å‘å¸ƒè¯´æ˜Žæ¨¡æ¿..."
            cp release_notes_template.md release_notes.md
          fi
          
          # æ·»åŠ ç»“å°¾ä¿¡æ¯
          cat >> release_notes.md << 'EOF'
          
          ## ðŸ“ å®Œæ•´æ›´æ–°æ—¥å¿—
          
          è¯·æŸ¥çœ‹é¡¹ç›®çš„ [æ›´æ–°æ—¥å¿—](https://github.com/mcardzh/gromacs-helper-vscode/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          
          ---
          
          ðŸ› **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/mcardzh/gromacs-helper-vscode/issues)
          ðŸ“– **ä½¿ç”¨æ–‡æ¡£**: [README](https://github.com/mcardzh/gromacs-helper-vscode#readme)
          EOF
          
          # ä¸ºè‡ªåŠ¨å‘å¸ƒæ·»åŠ ç‰¹æ®Šæ ‡è®°
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            sed -i '1s/^/ðŸ¤– **è‡ªåŠ¨å‘å¸ƒ** - æ£€æµ‹åˆ°ç‰ˆæœ¬å·å˜åŒ–è‡ªåŠ¨è§¦å‘\n\n/' release_notes.md
          fi
          
          echo "ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜Žï¼š"
          echo "=========================="
          cat release_notes.md
          echo "=========================="

      - name: é¢„è§ˆå‘å¸ƒè¯´æ˜Ž
        run: |
          echo "## ðŸ“‹ å‘å¸ƒè¯´æ˜Žé¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```markdown' >> $GITHUB_STEP_SUMMARY
          cat release_notes.md >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: "GROMACS Helper v${{ needs.build.outputs.version }}"
          body_path: release_notes.md
          files: "*.vsix"
          draft: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'draft' }}
          prerelease: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'prerelease' || github.event_name != 'workflow_dispatch' }}
          generate_release_notes: true
          fail_on_unmatched_files: false
          make_latest: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'release' || github.event_name != 'workflow_dispatch' }}
          token: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ°VS Code Marketplace
  marketplace:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true' && (github.event_name != 'workflow_dispatch' || (github.event.inputs.publish_marketplace == 'true' && github.event.inputs.release_type == 'release'))
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: vsix-package-${{ needs.build.outputs.version }}

      - name: éªŒè¯Marketplace Token
        run: |
          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "âŒ é”™è¯¯: æœªé…ç½® VSCE_PAT secret"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  VS Code Marketplace Personal Access Token"
            echo "è®¾ç½®è·¯å¾„: Settings -> Secrets and variables -> Actions -> Repository secrets"
            echo "Secret åç§°: VSCE_PAT"
            exit 1
          else
            echo "âœ… VSCE_PAT secret å·²é…ç½®"
          fi

      - name: å‘å¸ƒåˆ°Marketplace
        run: |
          # å®‰è£…vsce
          npm install -g @vscode/vsce
          
          echo "ðŸš€ å¼€å§‹å‘å¸ƒåˆ° VS Code Marketplace..."
          echo "ç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
          echo "VSIXæ–‡ä»¶: ${{ needs.build.outputs.vsix-name }}"
          
          # ä½¿ç”¨VSIXæ–‡ä»¶å‘å¸ƒåˆ°marketplace
          vsce publish --packagePath "${{ needs.build.outputs.vsix-name }}" --pat "${{ secrets.VSCE_PAT }}"
          
          echo "âœ… æˆåŠŸå‘å¸ƒåˆ° VS Code Marketplace!"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "## ðŸŽ‰ VS Code Marketplace å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VSIXæ–‡ä»¶**: ${{ needs.build.outputs.vsix-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=$(node -p 'require(\"./package.json\").publisher').$(node -p 'require(\"./package.json\").name'))" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ç”¨æˆ·å®‰è£…æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# é€šè¿‡ VS Code æ‰©å±•å¸‚åœºå®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "# 1. æ‰“å¼€ VS Code" >> $GITHUB_STEP_SUMMARY
          echo "# 2. æŒ‰ Ctrl+Shift+X (macOS: Cmd+Shift+X)" >> $GITHUB_STEP_SUMMARY
          echo "# 3. æœç´¢ \"GROMACS Helper\"" >> $GITHUB_STEP_SUMMARY
          echo "# 4. ç‚¹å‡»å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æˆ–é€šè¿‡å‘½ä»¤è¡Œå®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "code --install-extension $(node -p 'require(\"./package.json\").publisher').$(node -p 'require(\"./package.json\").name')" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # è‡ªåŠ¨æž„å»ºæ€»ç»“
  summary:
    needs: [build, release, marketplace]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æž„å»ºæ€»ç»“
        run: |
          echo "## ðŸŽ¯ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æ–¹å¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ needs.build.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VSIXæ–‡ä»¶ | ${{ needs.build.outputs.vsix-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºçŠ¶æ€ | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ReleaseçŠ¶æ€ | ${{ needs.release.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MarketplaceçŠ¶æ€ | ${{ needs.marketplace.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å˜åŒ– | ${{ needs.build.outputs.version_updated || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰§è¡Œå‘å¸ƒ | ${{ needs.build.outputs.should_release || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "### ðŸ“‹ æ‰‹åŠ¨æž„å»ºå‚æ•°" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‰ˆæœ¬å·**: ${{ github.event.inputs.version || 'æœªæŒ‡å®š (ä½¿ç”¨å½“å‰ç‰ˆæœ¬)' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æ›´æ–°ç‰ˆæœ¬**: ${{ github.event.inputs.update_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **å‘å¸ƒç±»åž‹**: ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            echo "- **åˆ›å»ºRelease**: ${{ github.event.inputs.create_release }}" >> $GITHUB_STEP_SUMMARY
            echo "- **è‡ªåŠ¨å˜æ›´æ—¥å¿—**: ${{ github.event.inputs.auto_changelog }}" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ github.event.inputs.custom_release_notes }}" ]; then
              echo "- **è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜Ž**: æ˜¯" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜Ž**: å¦" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **å‘å¸ƒåˆ°Marketplace**: ${{ github.event.inputs.publish_marketplace }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ¤– è‡ªåŠ¨æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "- **æž„å»ºå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.build.outputs.version_changed }}" = "true" ]; then
              echo "- **ç‰ˆæœ¬å˜åŒ–**: âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬å·å˜åŒ–ï¼Œè‡ªåŠ¨æ‰§è¡Œå‘å¸ƒæµç¨‹" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **ç‰ˆæœ¬å˜åŒ–**: âŒ æœªæ£€æµ‹åˆ°ç‰ˆæœ¬å·å˜åŒ–ï¼Œä»…æ‰§è¡Œæž„å»º" >> $GITHUB_STEP_SUMMARY
            fi
          fi
