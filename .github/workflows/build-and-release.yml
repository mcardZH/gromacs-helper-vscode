name: Build and Release VS Code Extension

on:
  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒå®Œæ•´æŽ§åˆ¶
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.3, 0.1.0) - ç•™ç©ºåˆ™è‡ªåŠ¨é€’å¢žpatchç‰ˆæœ¬'
        required: false
        type: string
      release_type:
        description: 'å‘å¸ƒç±»åž‹'
        required: true
        default: 'auto'
        type: choice
        options:
          - 'auto'       # æ ¹æ®åˆ†æ”¯è‡ªåŠ¨åˆ¤æ–­
          - 'release'    # å¼ºåˆ¶æ­£å¼å‘å¸ƒ
          - 'prerelease' # å¼ºåˆ¶é¢„å‘å¸ƒ
          - 'draft'      # è‰ç¨¿
      publish_marketplace:
        description: 'å‘å¸ƒåˆ°VS Code Marketplace'
        required: true
        default: false
        type: boolean
      custom_release_notes:
        description: 'è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜Ž (å¯é€‰)'
        required: false
        type: string

  # è‡ªåŠ¨è§¦å‘ - æŽ¨é€åˆ°åˆ†æ”¯æ—¶
  push:
    branches:
      - master
      - main
      - prerelease
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/workflows/scheduled-merge.yml'
      - '.github/workflows/pr-check.yml'

  # Pull Request æ£€æŸ¥
  pull_request:
    branches:
      - master
      - main

permissions:
  contents: write
  pull-requests: read
  issues: read
  packages: write

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # æž„å»ºä»»åŠ¡
  # ============================================
  build:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      vsix_name: ${{ steps.build.outputs.vsix_name }}
      should_release: ${{ steps.version.outputs.should_release }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      publish_marketplace: ${{ steps.version.outputs.publish_marketplace }}
      version_bumped: ${{ steps.version.outputs.version_bumped }}
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: å¤„ç†ç‰ˆæœ¬å·å’Œå‘å¸ƒç­–ç•¥
        id: version
        run: |
          set -e
          
          # èŽ·å–å½“å‰åˆ†æ”¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CURRENT_BRANCH="${{ github.base_ref }}"
            echo "PR ç›®æ ‡åˆ†æ”¯: $CURRENT_BRANCH"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "publish_marketplace=false" >> $GITHUB_OUTPUT
            echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
            echo "version_bumped=false" >> $GITHUB_OUTPUT
            exit 0
          else
            CURRENT_BRANCH="${{ github.ref_name }}"
          fi
          
          echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          
          # è¯»å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "å½“å‰ package.json ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # åˆ¤æ–­å‘å¸ƒç±»åž‹
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            if [ "$RELEASE_TYPE" = "auto" ]; then
              if [ "$CURRENT_BRANCH" = "prerelease" ]; then
                IS_PRERELEASE=true
              else
                IS_PRERELEASE=false
              fi
            elif [ "$RELEASE_TYPE" = "prerelease" ]; then
              IS_PRERELEASE=true
            else
              IS_PRERELEASE=false
            fi
            SHOULD_RELEASE=true
            
            # æ£€æŸ¥æ˜¯å¦å‘å¸ƒåˆ° Marketplace
            if [ "${{ github.event.inputs.publish_marketplace }}" = "true" ] && [ "$IS_PRERELEASE" = "false" ]; then
              PUBLISH_MARKETPLACE=true
            else
              PUBLISH_MARKETPLACE=false
            fi
          else
            # è‡ªåŠ¨è§¦å‘ - æ ¹æ®åˆ†æ”¯åˆ¤æ–­
            if [ "$CURRENT_BRANCH" = "prerelease" ]; then
              IS_PRERELEASE=true
              PUBLISH_MARKETPLACE=false
            else
              IS_PRERELEASE=false
              PUBLISH_MARKETPLACE=true  # master åˆ†æ”¯è‡ªåŠ¨å‘å¸ƒåˆ° Marketplace
            fi
            SHOULD_RELEASE=true
          fi
          
          echo "å‘å¸ƒç±»åž‹: $([ "$IS_PRERELEASE" = "true" ] && echo "é¢„å‘å¸ƒ" || echo "æ­£å¼å‘å¸ƒ")"
          echo "å‘å¸ƒåˆ° Marketplace: $PUBLISH_MARKETPLACE"
          
          # å¤„ç†ç‰ˆæœ¬å·
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·
            NEW_VERSION="${{ github.event.inputs.version }}"
            VERSION_BUMPED=true
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬å·: $NEW_VERSION"
          else
            # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å·²ç»æ›´æ–°
            PREVIOUS_VERSION=""
            if git show HEAD~1:package.json > /dev/null 2>&1; then
              PREVIOUS_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version" 2>/dev/null || echo "")
            fi
            
            echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: ${PREVIOUS_VERSION:-'æ— æ³•èŽ·å–'}"
            
            if [ -n "$PREVIOUS_VERSION" ] && [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              # ç‰ˆæœ¬å·²æ›´æ–°
              NEW_VERSION="$CURRENT_VERSION"
              VERSION_BUMPED=false
              echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬å·²æ›´æ–°: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
            else
              # ç‰ˆæœ¬æœªæ›´æ–°ï¼Œè‡ªåŠ¨é€’å¢ž patch
              echo "âš ï¸ ç‰ˆæœ¬æœªæ›´æ–°ï¼Œè‡ªåŠ¨é€’å¢ž patch ç‰ˆæœ¬..."
              
              # è§£æžç‰ˆæœ¬å·
              MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
              MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
              PATCH=$(echo $CURRENT_VERSION | cut -d. -f3 | cut -d- -f1)
              
              # é€’å¢ž patch
              NEW_PATCH=$((PATCH + 1))
              
              if [ "$IS_PRERELEASE" = "true" ]; then
                # é¢„å‘å¸ƒç‰ˆæœ¬æ·»åŠ åŽç¼€
                NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-pre.${{ github.run_number }}"
              else
                NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
              fi
              
              VERSION_BUMPED=true
              echo "è‡ªåŠ¨é€’å¢žç‰ˆæœ¬: $CURRENT_VERSION â†’ $NEW_VERSION"
            fi
          fi
          
          # å¦‚æžœéœ€è¦æ›´æ–°ç‰ˆæœ¬å·ï¼Œæäº¤åˆ°ä»“åº“
          if [ "$VERSION_BUMPED" = "true" ]; then
            echo "ðŸ“ æ›´æ–° package.json ç‰ˆæœ¬å·..."
            npm version $NEW_VERSION --no-git-tag-version
            
            # é…ç½® git
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # æäº¤ç‰ˆæœ¬æ›´æ–°
            git add package.json package-lock.json
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
            git push origin $CURRENT_BRANCH
            
            echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°å¹¶æŽ¨é€"
          fi
          
          # è¾“å‡ºå˜é‡
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "publish_marketplace=$PUBLISH_MARKETPLACE" >> $GITHUB_OUTPUT
          echo "version_bumped=$VERSION_BUMPED" >> $GITHUB_OUTPUT

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: éªŒè¯æž„å»º
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºäº§ç‰©..."
          node -e "
            const assert = require('assert');
            const fs = require('fs');
            
            console.log('éªŒè¯ package.json...');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            assert.ok(pkg.name, 'Package name should exist');
            assert.ok(pkg.version, 'Package version should exist');
            assert.ok(pkg.engines.vscode, 'VS Code engine should be specified');
            
            console.log('éªŒè¯ç¼–è¯‘äº§ç‰©...');
            assert.ok(fs.existsSync('dist/extension.js'), 'Compiled extension should exist');
            
            console.log('éªŒè¯è¯­è¨€é…ç½®æ–‡ä»¶...');
            const languageFiles = [
              'syntaxes/mdp/mdp.tmLanguage.json',
              'syntaxes/gro/gro.tmLanguage.json', 
              'syntaxes/top/top.tmLanguage.json',
              'syntaxes/ndx/ndx.tmLanguage.json'
            ];
            languageFiles.forEach(file => {
              assert.ok(fs.existsSync(file), \`Language file \${file} should exist\`);
            });
            
            console.log('âœ… æ‰€æœ‰æž„å»ºéªŒè¯é€šè¿‡ï¼');
          "

      - name: æ‰“åŒ…æ‰©å±•
        id: build
        run: |
          # å®‰è£… vsce
          npm install -g @vscode/vsce
          
          VERSION="${{ steps.version.outputs.version }}"
          echo "æ‰“åŒ…ç‰ˆæœ¬: $VERSION"
          
          # æ‰“åŒ…
          if [ "${{ steps.version.outputs.is_prerelease }}" = "true" ]; then
            vsce package --pre-release --out "gromacs-helper-vscode-${VERSION}.vsix"
          else
            vsce package --out "gromacs-helper-vscode-${VERSION}.vsix"
          fi
          
          VSIX_FILE="gromacs-helper-vscode-${VERSION}.vsix"
          echo "ç”Ÿæˆçš„ VSIX æ–‡ä»¶: $VSIX_FILE"
          echo "vsix_name=$VSIX_FILE" >> $GITHUB_OUTPUT
          
          ls -la *.vsix

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package-${{ steps.version.outputs.version }}
          path: "*.vsix"
          retention-days: 30

  # ============================================
  # å‘å¸ƒä»»åŠ¡
  # ============================================
  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true' && github.event_name != 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: vsix-package-${{ needs.build.outputs.version }}

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          VSIX_FILE="${{ needs.build.outputs.vsix_name }}"
          IS_PRERELEASE="${{ needs.build.outputs.is_prerelease }}"
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Žæ¨¡æ¿
          if [ "$IS_PRERELEASE" = "true" ]; then
            RELEASE_BADGE="ðŸ§ª **é¢„å‘å¸ƒç‰ˆæœ¬** - æ­¤ç‰ˆæœ¬ç”¨äºŽæµ‹è¯•ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½"
          else
            RELEASE_BADGE="ðŸŽ‰ **æ­£å¼å‘å¸ƒç‰ˆæœ¬**"
          fi
          
          cat > release_notes.md << EOF
          # GROMACS Helper for VS Code v${VERSION}
          
          ${RELEASE_BADGE}
          
          ## ðŸ“¦ å®‰è£…æ–¹å¼
          
          ### æ–¹å¼ä¸€ï¼šé€šè¿‡VS Codeæ‰©å±•å¸‚åœºå®‰è£…
          1. æ‰“å¼€ VS Code
          2. æŒ‰ \`Ctrl+Shift+X\` (macOS: \`Cmd+Shift+X\`)
          3. æœç´¢ "GROMACS Helper for VS Code"
          4. ç‚¹å‡»å®‰è£…æŒ‰é’®
          
          ### æ–¹æ³•äºŒï¼šä»ŽVSIXæ–‡ä»¶å®‰è£…
          1. ä¸‹è½½é™„ä»¶ä¸­çš„ \`${VSIX_FILE}\` æ–‡ä»¶
          2. åœ¨VS Codeä¸­æŒ‰ \`Ctrl+Shift+P\` (macOS: \`Cmd+Shift+P\`)
          3. è¾“å…¥ "Extensions: Install from VSIX..."
          4. é€‰æ‹©ä¸‹è½½çš„VSIXæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ### æ–¹æ³•ä¸‰ï¼šå‘½ä»¤è¡Œå®‰è£…
          \`\`\`bash
          code --install-extension ${VSIX_FILE}
          \`\`\`
          
          EOF
          
          # å°è¯•ä»Ž CHANGELOG.md æå–å†…å®¹
          if [ -f "CHANGELOG.md" ]; then
            VERSION_CLEAN=$(echo "$VERSION" | sed 's/^v//' | sed 's/-pre\..*//')
            echo "æŸ¥æ‰¾ç‰ˆæœ¬: $VERSION_CLEAN"
            
            CHANGELOG_CONTENT=$(awk "
              /^## \\[${VERSION_CLEAN}\\]/ { found=1; next }
              found && /^## \\[/ { exit }
              found { print }
            " CHANGELOG.md | head -50)
            
            if [ -n "$CHANGELOG_CONTENT" ]; then
              echo "" >> release_notes.md
              echo "## ðŸ“ æœ¬ç‰ˆæœ¬æ›´æ–°" >> release_notes.md
              echo "" >> release_notes.md
              echo "$CHANGELOG_CONTENT" >> release_notes.md
            fi
          fi
          
          # æ·»åŠ è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜Ž
          if [ -n "${{ github.event.inputs.custom_release_notes }}" ]; then
            echo "" >> release_notes.md
            echo "## ðŸ“‹ é™„åŠ è¯´æ˜Ž" >> release_notes.md
            echo "" >> release_notes.md
            echo "${{ github.event.inputs.custom_release_notes }}" >> release_notes.md
          fi
          
          # æ·»åŠ é“¾æŽ¥
          cat >> release_notes.md << 'EOF'
          
          ---
          
          ðŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/mcardzh/gromacs-helper-vscode#readme) | ðŸ› [é—®é¢˜åé¦ˆ](https://github.com/mcardzh/gromacs-helper-vscode/issues) | ðŸ“ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/mcardzh/gromacs-helper-vscode/blob/master/CHANGELOG.md)
          EOF
          
          echo "ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜Žï¼š"
          cat release_notes.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: "GROMACS Helper v${{ needs.build.outputs.version }}"
          body_path: release_notes.md
          files: "*.vsix"
          draft: ${{ github.event.inputs.release_type == 'draft' }}
          prerelease: ${{ needs.build.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          fail_on_unmatched_files: false
          make_latest: ${{ needs.build.outputs.is_prerelease != 'true' }}
          token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # å‘å¸ƒåˆ° VS Code Marketplace
  # ============================================
  marketplace:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: needs.build.outputs.publish_marketplace == 'true' && needs.build.outputs.is_prerelease != 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: vsix-package-${{ needs.build.outputs.version }}

      - name: éªŒè¯ Marketplace Token
        run: |
          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "âŒ é”™è¯¯: æœªé…ç½® VSCE_PAT secret"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  VS Code Marketplace Personal Access Token"
            exit 1
          fi
          echo "âœ… VSCE_PAT secret å·²é…ç½®"

      - name: å‘å¸ƒåˆ° Marketplace
        run: |
          npm install -g @vscode/vsce
          
          echo "ðŸš€ å‘å¸ƒåˆ° VS Code Marketplace..."
          echo "ç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
          
          vsce publish --packagePath "${{ needs.build.outputs.vsix_name }}" --pat "${{ secrets.VSCE_PAT }}"
          
          echo "âœ… æˆåŠŸå‘å¸ƒåˆ° VS Code Marketplace!"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "## ðŸŽ‰ VS Code Marketplace å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=mcardzh.gromacs-helper-vscode)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # æž„å»ºæ€»ç»“
  # ============================================
  summary:
    needs: [build, release, marketplace]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æž„å»ºæ€»ç»“
        run: |
          echo "## ðŸŽ¯ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æ–¹å¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ needs.build.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬è‡ªåŠ¨é€’å¢ž | ${{ needs.build.outputs.version_bumped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é¢„å‘å¸ƒ | ${{ needs.build.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºçŠ¶æ€ | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ReleaseçŠ¶æ€ | ${{ needs.release.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MarketplaceçŠ¶æ€ | ${{ needs.marketplace.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
