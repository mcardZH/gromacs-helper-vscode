name: Build and Release VS Code Extension

on:
  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒç‰ˆæœ¬å·æ›´æ–°
  workflow_dispatch:
    inputs:
      version:
        description: 'æ–°ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.3, 0.1.0, 1.0.0-beta.1)'
        required: true
        type: string
      release_type:
        description: 'å‘å¸ƒç±»åž‹'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - 'release'
          - 'prerelease'
          - 'draft'
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºGitHub Release'
        required: true
        default: true
        type: boolean

  # è‡ªåŠ¨è§¦å‘ - æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»ºï¼ˆä¸æ›´æ–°ç‰ˆæœ¬å·ï¼‰
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

  # Pull Requestè§¦å‘
  pull_request:
    branches:
      - main
      - master

env:
  NODE_VERSION: '18'

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      vsix-name: ${{ steps.build.outputs.vsix-name }}
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: å¤„ç†ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ - ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç‰ˆæœ¬å·
            NEW_VERSION="${{ github.event.inputs.version }}"
            echo "æ›´æ–°ç‰ˆæœ¬å·åˆ°: $NEW_VERSION"
            npm version $NEW_VERSION --no-git-tag-version
            
            # é…ç½®gitç”¨æˆ·ä¿¡æ¯
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # æäº¤ç‰ˆæœ¬æ›´æ”¹
            git add package.json
            git commit -m "chore: bump version to $NEW_VERSION" || echo "No changes to commit"
            git push origin ${{ github.ref_name }} || echo "No changes to push"
            
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
          else
            # è‡ªåŠ¨è§¦å‘ - ä¸æ›´æ–°ç‰ˆæœ¬å·ï¼Œä½†å¢žåŠ æž„å»ºå·
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            BUILD_NUMBER=${{ github.run_number }}
            VERSION_WITH_BUILD="${CURRENT_VERSION}+build.${BUILD_NUMBER}"
            
            echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
            echo "æž„å»ºç‰ˆæœ¬: $VERSION_WITH_BUILD"
            echo "version=$VERSION_WITH_BUILD" >> $GITHUB_OUTPUT
            echo "is_manual=false" >> $GITHUB_OUTPUT
          fi

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: è¿è¡Œæµ‹è¯•
        run: |
          if [ -f "package.json" ] && npm run | grep -q "test"; then
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æµ‹è¯•é…ç½®æ–‡ä»¶
            if [ -f ".vscode-test.mjs" ] || [ -f ".vscode-test.js" ]; then
              echo "è¿è¡Œæ‰©å±•æµ‹è¯•..."
              npm test
            else
              echo "è·³è¿‡æµ‹è¯• - æœªæ‰¾åˆ° .vscode-test é…ç½®æ–‡ä»¶"
            fi
          else
            echo "è·³è¿‡æµ‹è¯• - æœªé…ç½®æµ‹è¯•å‘½ä»¤"
          fi

      - name: æ‰“åŒ…æ‰©å±•
        id: build
        run: |
          # å®‰è£…vsceå¦‚æžœæ²¡æœ‰
          if ! command -v vsce &> /dev/null; then
            npm install -g @vscode/vsce
          fi
          
          # æ‰“åŒ…æ‰©å±•
          if [ "${{ steps.version.outputs.is_manual }}" = "true" ]; then
            # æ‰‹åŠ¨è§¦å‘ - ä½¿ç”¨package.jsonä¸­çš„ç‰ˆæœ¬å·
            vsce package
            VSIX_FILE=$(ls *.vsix | head -n 1)
          else
            # è‡ªåŠ¨è§¦å‘ - ä½¿ç”¨å¸¦æž„å»ºå·çš„ç‰ˆæœ¬
            vsce package --out "gromacs-helper-vscode-${{ steps.version.outputs.version }}.vsix"
            VSIX_FILE="gromacs-helper-vscode-${{ steps.version.outputs.version }}.vsix"
          fi
          
          echo "ç”Ÿæˆçš„VSIXæ–‡ä»¶: $VSIX_FILE"
          echo "vsix-name=$VSIX_FILE" >> $GITHUB_OUTPUT
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$VSIX_FILE" ]; then
            echo "é”™è¯¯: VSIXæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -la *.vsix

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package-${{ steps.version.outputs.version }}
          path: "*.vsix"
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: vsix-package-${{ needs.build.outputs.version }}

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          VSIX_FILE="${{ needs.build.outputs.vsix-name }}"
          
          cat > release_notes.md << EOF
          # GROMACS Helper for VS Code v${VERSION}
          
          ## ðŸ“¦ å®‰è£…æ–¹å¼
          
          ### æ–¹æ³•ä¸€ï¼šä»ŽVSIXæ–‡ä»¶å®‰è£…
          1. ä¸‹è½½é™„ä»¶ä¸­çš„ \`${VSIX_FILE}\` æ–‡ä»¶
          2. åœ¨VS Codeä¸­æŒ‰ \`Ctrl+Shift+P\` (macOS: \`Cmd+Shift+P\`)
          3. è¾“å…¥ "Extensions: Install from VSIX..."
          4. é€‰æ‹©ä¸‹è½½çš„VSIXæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ### æ–¹æ³•äºŒï¼šå‘½ä»¤è¡Œå®‰è£…
          \`\`\`bash
          code --install-extension ${VSIX_FILE}
          \`\`\`
          
          ## ðŸš€ åŠŸèƒ½ç‰¹æ€§
          
          - ðŸ“ **è¯­æ³•é«˜äº®**: å®Œæ•´æ”¯æŒMDPã€TOPã€GROã€NDXæ–‡ä»¶æ ¼å¼
          - ðŸ” **æ™ºèƒ½æç¤º**: å‚æ•°è‡ªåŠ¨è¡¥å…¨å’Œæ‚¬åœå¸®åŠ©
          - ðŸ“‹ **ä»£ç ç‰‡æ®µ**: å¸¸ç”¨æ¨¡æ¿å¿«é€Ÿæ’å…¥
          - ðŸŽ¯ **ç¬¦å·å¯¼èˆª**: å¿«é€Ÿè·³è½¬å’Œå¤§çº²è§†å›¾
          - ðŸ“ **ä»£ç æ ¼å¼åŒ–**: è‡ªåŠ¨æ ¼å¼åŒ–æ”¯æŒ
          - ðŸ”§ **è¯Šæ–­åŠŸèƒ½**: å®žæ—¶é”™è¯¯æ£€æŸ¥å’Œå»ºè®®
          
          ## ðŸ”§ æ”¯æŒçš„æ–‡ä»¶ç±»åž‹
          
          - **MDPæ–‡ä»¶** (.mdp) - åˆ†å­åŠ¨åŠ›å­¦å‚æ•°æ–‡ä»¶
          - **TOPæ–‡ä»¶** (.top, .itp) - æ‹“æ‰‘æ–‡ä»¶
          - **GROæ–‡ä»¶** (.gro) - ç»“æž„åæ ‡æ–‡ä»¶  
          - **NDXæ–‡ä»¶** (.ndx) - ç´¢å¼•æ–‡ä»¶
          
          ## ðŸ“ æ›´æ–°æ—¥å¿—
          
          è¯·æŸ¥çœ‹é¡¹ç›®çš„ [æ›´æ–°æ—¥å¿—](https://github.com/gromacs-helper/gromacs-helper-vscode/releases) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          
          ---
          
          ðŸ› **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/gromacs-helper/gromacs-helper-vscode/issues)
          ðŸ“– **ä½¿ç”¨æ–‡æ¡£**: [README](https://github.com/gromacs-helper/gromacs-helper-vscode#readme)
          EOF

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: "GROMACS Helper v${{ needs.build.outputs.version }}"
          body_path: release_notes.md
          files: "*.vsix"
          draft: ${{ github.event.inputs.release_type == 'draft' }}
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # è‡ªåŠ¨æž„å»ºæ€»ç»“
  summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æž„å»ºæ€»ç»“
        run: |
          echo "## ðŸŽ¯ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æ–¹å¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ needs.build.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VSIXæ–‡ä»¶ | ${{ needs.build.outputs.vsix-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºçŠ¶æ€ | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "### ðŸ“‹ æ‰‹åŠ¨æž„å»ºå‚æ•°" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‰ˆæœ¬å·**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **å‘å¸ƒç±»åž‹**: ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            echo "- **åˆ›å»ºRelease**: ${{ github.event.inputs.create_release }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ¤– è‡ªåŠ¨æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "- **æž„å»ºå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          fi
