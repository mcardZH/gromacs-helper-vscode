name: Scheduled Merge Prerelease to Master

on:
  # æ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´ä¸‹åˆ5ç‚¹ (UTC 09:00) è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 9 * * 1'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_merge:
        description: 'å¼ºåˆ¶åˆ›å»ºPRï¼ˆå³ä½¿æ²¡æœ‰æ–°æäº¤ï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥åˆ†æ”¯çŠ¶æ€
        id: check
        run: |
          # ç¡®ä¿ä¸¤ä¸ªåˆ†æ”¯éƒ½å­˜åœ¨
          git fetch origin master prerelease || true
          
          if ! git show-ref --verify --quiet refs/remotes/origin/prerelease; then
            echo "âš ï¸ prerelease åˆ†æ”¯ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆå¹¶"
            echo "should_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # èŽ·å–åˆ†æ”¯é—´çš„å·®å¼‚æäº¤æ•°
          AHEAD=$(git rev-list --count origin/master..origin/prerelease 2>/dev/null || echo "0")
          echo "prerelease åˆ†æ”¯é¢†å…ˆ master $AHEAD ä¸ªæäº¤"
          
          if [ "$AHEAD" = "0" ] && [ "${{ github.event.inputs.force_merge }}" != "true" ]; then
            echo "â„¹ï¸ prerelease åˆ†æ”¯æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡åˆå¹¶"
            echo "should_merge=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ£€æµ‹åˆ°éœ€è¦åˆå¹¶çš„æäº¤"
            echo "should_merge=true" >> $GITHUB_OUTPUT
            echo "commits_ahead=$AHEAD" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨åˆå¹¶
        id: merge_check
        if: steps.check.outputs.should_merge == 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
          git checkout master
          if git merge --no-commit --no-ff origin/prerelease 2>/dev/null; then
            echo "âœ… å¯ä»¥è‡ªåŠ¨åˆå¹¶ï¼Œæ— å†²çª"
            echo "can_auto_merge=true" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
          else
            echo "âš ï¸ å­˜åœ¨åˆå¹¶å†²çªï¼Œéœ€è¦åˆ›å»º PR æ‰‹åŠ¨è§£å†³"
            echo "can_auto_merge=false" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
          fi

      - name: åˆ›å»º Pull Request
        if: steps.check.outputs.should_merge == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-merge/prerelease-to-master
          base: master
          title: "ðŸ”„ å®šæ—¶åˆå¹¶: prerelease â†’ master"
          body: |
            ## è‡ªåŠ¨åˆå¹¶è¯·æ±‚
            
            æ­¤ PR ç”±å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åˆ›å»ºï¼Œå°† `prerelease` åˆ†æ”¯çš„æ›´æ”¹åˆå¹¶åˆ° `master` åˆ†æ”¯ã€‚
            
            ### ðŸ“Š åˆå¹¶ä¿¡æ¯
            - **è§¦å‘æ—¶é—´**: ${{ github.event.schedule && 'æ¯å‘¨ä¸€ 17:00 åŒ—äº¬æ—¶é—´' || 'æ‰‹åŠ¨è§¦å‘' }}
            - **æäº¤æ•°é‡**: ${{ steps.check.outputs.commits_ahead }} ä¸ªæ–°æäº¤
            - **è‡ªåŠ¨åˆå¹¶**: ${{ steps.merge_check.outputs.can_auto_merge == 'true' && 'âœ… å¯ä»¥' || 'âš ï¸ å­˜åœ¨å†²çª' }}
            
            ### ðŸ“‹ å˜æ›´å†…å®¹
            è¯·æŸ¥çœ‹ä¸‹æ–¹çš„æ–‡ä»¶å˜æ›´åˆ—è¡¨ã€‚
            
            ---
            
            ${{ steps.merge_check.outputs.can_auto_merge == 'true' && '> âœ… æ­¤ PR å¯ä»¥å®‰å…¨åˆå¹¶ï¼Œè¯·å®¡æ ¸åŽç‚¹å‡»åˆå¹¶æŒ‰é’®ã€‚' || '> âš ï¸ æ­¤ PR å­˜åœ¨åˆå¹¶å†²çªï¼Œè¯·å…ˆè§£å†³å†²çªåŽå†åˆå¹¶ã€‚' }}
          labels: |
            automated
            merge
          draft: ${{ steps.merge_check.outputs.can_auto_merge != 'true' }}

      - name: è¾“å‡ºç»“æžœ
        run: |
          echo "## ðŸ”„ å®šæ—¶åˆå¹¶ä»»åŠ¡å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.should_merge }}" = "true" ]; then
            echo "âœ… å·²åˆ›å»º Pull Requestï¼Œç­‰å¾…å®¡æ ¸åˆå¹¶" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.merge_check.outputs.can_auto_merge }}" = "true" ]; then
              echo "- çŠ¶æ€: å¯ä»¥å®‰å…¨åˆå¹¶" >> $GITHUB_STEP_SUMMARY
            else
              echo "- çŠ¶æ€: âš ï¸ å­˜åœ¨å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ prerelease åˆ†æ”¯æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡æœ¬æ¬¡åˆå¹¶" >> $GITHUB_STEP_SUMMARY
          fi
